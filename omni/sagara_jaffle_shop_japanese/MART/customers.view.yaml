# Reference this view as mart__customers
#This description was pulled from dbt.
description: 顧客概要データマート。各ユニーク顧客の主要な詳細情報を提供します。顧客ごとに1行。

schema: MART
table_name: CUSTOMERS

dimensions:
  customer_id:
    sql: '"CUSTOMER_ID"'
    format: ID
    #This description was pulled from dbt.
    description: 注文マートのユニークキー。

  customer_name:
    sql: '"CUSTOMER_NAME"'
    #This description was pulled from dbt.
    description: 顧客のフルネーム。

  first_ordered_at:
    sql: '"FIRST_ORDERED_AT"'
    #This description was pulled from dbt.
    description: 顧客が最初の注文を行ったタイムスタンプ。

  last_ordered_at:
    sql: '"LAST_ORDERED_AT"'
    #This description was pulled from dbt.
    description: 顧客の最新注文のタイムスタンプ。

  lifetime_spend_pretax:
    sql: '"LIFETIME_SPEND_PRETAX"'
    #This description was pulled from dbt.
    description: 顧客が行ったすべての注文の税抜小計の合計。

  lifetime_tax_paid:
    sql: '"LIFETIME_TAX_PAID"'
    #This description was pulled from dbt.
    description: 顧客が行ったすべての注文の税額部分の合計。

  lifetime_spend:
    sql: '"LIFETIME_SPEND"'
    #This description was pulled from dbt.
    description: 顧客がこれまでに行ったすべての注文合計（税込）の合計。

  customer_type:
    sql: '"CUSTOMER_TYPE"'
    #This description was pulled from dbt.
    description: 「new」または「returning」のいずれか。顧客が複数回注文しているか、現在までに初回注文のみを行っているかを示します。
    all_values: [ new, returning ]

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: customers
  target_schema: PROD
  description: 顧客概要データマート。各ユニーク顧客の主要な詳細情報を提供します。顧客ごとに1行。
  config:
    schema: mart
    materialized: table
  code: |-
    with

    customers as (

        select * from {{ ref('stg_customers') }}

    ),

    orders as (

        select * from {{ ref('orders') }}

    ),

    customer_orders_summary as (

        select
            orders.customer_id,

            count(distinct orders.order_id) as count_lifetime_orders,
            count(distinct orders.order_id) > 1 as is_repeat_buyer,
            -- min(orders.ordered_at) as first_ordered_at,
            -- max(orders.ordered_at) as last_ordered_at,
            min(orders.purchased_at) as first_ordered_at,
            max(orders.purchased_at) as last_ordered_at,
            sum(orders.subtotal) as lifetime_spend_pretax,
            sum(orders.tax_paid) as lifetime_tax_paid,
            sum(orders.order_total) as lifetime_spend

        from orders

        group by 1

    ),

    joined as (

        select
            customers.*,

            -- customer_orders_summary.count_lifetime_orders,
            customer_orders_summary.first_ordered_at,
            customer_orders_summary.last_ordered_at,
            customer_orders_summary.lifetime_spend_pretax,
            customer_orders_summary.lifetime_tax_paid,
            customer_orders_summary.lifetime_spend,

            case
                when customer_orders_summary.is_repeat_buyer then 'returning'
                else 'new'
            end as customer_type

        from customers

        left join customer_orders_summary
            on customers.customer_id = customer_orders_summary.customer_id

    )

    select * from joined
